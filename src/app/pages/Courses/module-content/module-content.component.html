<div class="module-layout" *ngIf="!isLoading && !error && currentParsedContent">

  <!-- Sidebar Navigation -->
  <div class="sidebar-nav">
    <div class="module-header-compact">
      <div class="module-number-badge">{{ formatModuleNumber() }}</div>
      <h2 class="module-title-compact">{{ moduleTitle }}</h2>
      <p class="module-description" *ngIf="moduleDescription">
        {{ moduleDescription }}
      </p>
      <div class="module-progress-mini" [style.--progress]="progressPercentage">
        <div class="progress-circle">
          <span>{{ progressPercentage }}%</span>
        </div>
        <span>{{ completedContents }} of {{ totalContents }} content blocks completed</span>
      </div>
    </div>

    <div class="content-list">
      <div
        *ngFor="let contentItem of content; let i = index"
        class="content-list-item"
        [class.completed]="contentItem.progress?.is_completed || completedContentIds.has(contentItem.id)"
        [class.active]="isContentActive(i)"
        (click)="selectContent(i)">
        <div class="content-icon">
          <i *ngIf="contentItem.progress?.is_completed || completedContentIds.has(contentItem.id)" class="fas fa-check"></i>
          <i *ngIf="!contentItem.progress?.is_completed && !completedContentIds.has(contentItem.id)" class="fas fa-file-alt"></i>
        </div>
        <div class="content-item-info">
          <div class="content-item-title">
            {{ getContentTitle(i) }}
          </div>
          <div class="content-item-type">Content Block</div>
        </div>
      </div>
    </div>

    <!-- Quiz Item in Sidebar -->
    <div
      class="content-list-item quiz-item"
      *ngIf="module?.has_quiz && quiz"
      [class.disabled]="!canTakeQuiz"
      [class.completed]="quiz.student_passed"
      [title]="quizDisabledReason || ''"
      (click)="canTakeQuiz ? takeQuiz() : null">
      <div class="content-icon quiz-icon">
        <i class="fas"
           [class.fa-check]="quiz.student_passed"
           [class.fa-question-circle]="canTakeQuiz && !quiz.student_passed"
           [class.fa-clock]="!canTakeQuiz && !quiz.student_passed && cooldownTimeRemaining"
           [class.fa-lock]="!canTakeQuiz && !quiz.student_passed && !cooldownTimeRemaining"></i>
      </div>
      <div class="content-item-info">
        <div class="content-item-title">{{ quiz.title }}</div>
        <div class="content-item-type">
          <!-- âœ… Show completion status -->
          <span *ngIf="quiz.student_passed" class="completed-text">
            <i class="fas fa-check"></i> Completed
          </span>
          <!-- âœ… Show cooldown timer -->
          <span *ngIf="!canTakeQuiz && !quiz.student_passed && cooldownTimeRemaining" class="cooldown-text">
            <i class="fas fa-clock"></i> {{ cooldownTimeRemaining }}
          </span>
          <span *ngIf="!canTakeQuiz && !quiz.student_passed && !cooldownTimeRemaining">
            {{ quizDisabledReason }}
          </span>
          <span *ngIf="canTakeQuiz && !quiz.student_passed">Module Quiz</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="content-main">

    <!-- Content Header -->
    <div class="content-header" *ngIf="currentContent">
      <div class="content-type-badge">
        <i class="fas fa-file-alt"></i>
        <span>Text Content</span>
      </div>
      <h1 class="content-title">
        {{ getContentTitle(currentContentIndex) }}
      </h1>
      <div class="content-meta">
        <div class="meta-item">
          <i class="fas fa-clock"></i>
          <span>{{ getEstimatedReadTime(currentContent) }}</span>
        </div>
        <div class="meta-item">
          <i class="fas fa-list-ol"></i>
          <span>Content {{ currentContentIndex + 1 }} of {{ totalContents }}</span>
        </div>
        <div class="meta-item">
          <i class="fas fa-calendar"></i>
          <span>Added: {{ currentContent.created_at | date: 'MMM yyyy' }}</span>
        </div>
        <div class="meta-item" *ngIf="currentContent.progress?.is_completed">
          <i class="fas fa-check-circle"></i>
          <span>Completed</span>
        </div>
      </div>
    </div>
    <!-- âœ… CLOSED content-header div -->

    <!-- Content Body -->
    <div class="content-body" *ngIf="currentParsedContent">
      <div class="content-text">
        <div class="tiptap-content" [innerHTML]="currentParsedContent.html"></div>
      </div>
    </div>

    <!-- Quiz Prompt -->
    <div class="quiz-prompt" *ngIf="isLastContent && module?.has_quiz && quiz && !quiz.student_passed">
      <div class="quiz-icon-large">
        <i class="fas"
           [class.fa-question-circle]="canTakeQuiz"
           [class.fa-clock]="!canTakeQuiz && cooldownTimeRemaining"
           [class.fa-lock]="!canTakeQuiz && !cooldownTimeRemaining"></i>
      </div>
      <div class="quiz-info">
        <div class="quiz-title">{{ quiz.title }}</div>
        <div class="quiz-description" *ngIf="quiz.description">
          {{ quiz.description }}
        </div>
        <div class="quiz-description" *ngIf="!quiz.description">
          Test your knowledge and complete this module by taking the quiz.
        </div>

        <!-- âœ… Cooldown notice -->
        <div class="cooldown-notice" *ngIf="!canTakeQuiz && cooldownTimeRemaining">
          <i class="fas fa-clock"></i>
          <span>Next attempt available in <strong>{{ cooldownTimeRemaining }}</strong></span>
        </div>

        <div class="quiz-meta">
          <div class="quiz-meta-item" *ngIf="quiz.time_limit_minutes">
            <i class="fas fa-clock"></i>
            <span>{{ quiz.time_limit_minutes }} minutes</span>
          </div>
          <div class="quiz-meta-item">
            <i class="fas fa-question-circle"></i>
            <span>{{ quiz.question_count }} questions</span>
          </div>
          <div class="quiz-meta-item" *ngIf="quiz.student_passed">
            <i class="fas fa-check-circle"></i>
            <span>Passed</span>
          </div>
          <div class="quiz-meta-item" *ngIf="!quiz.student_can_attempt && !quiz.student_passed && !cooldownTimeRemaining">
            <i class="fas fa-lock"></i>
            <span>No attempts remaining</span>
          </div>
        </div>
      </div>
    </div>

    <!-- âœ… Module Completed Message (when quiz is passed) -->
    <div class="module-completed-banner" *ngIf="quiz?.student_passed && module?.progress?.status === 'completed'">
      <div class="completion-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <div class="completion-info">
        <h3 class="completion-title">ðŸŽ‰ Module Completed!</h3>
        <p class="completion-message">
          Congratulations! You've successfully completed all content and passed the quiz for this module.
        </p>
      </div>
    </div>

    <!-- âœ… NEW: Final Exam Prompt -->
    <div class="final-exam-prompt" *ngIf="shouldShowFinalExamPrompt">
      <div class="final-exam-header">
        <div class="final-exam-icon-large">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="final-exam-title-section">
          <h2 class="final-exam-title">Ready for the Final Exam?</h2>
          <p class="final-exam-subtitle">
            You've completed all modules! Take the final exam to earn your certificate.
          </p>
        </div>
      </div>

      <div class="final-exam-body">
        <div class="final-exam-info">
          <h3 class="exam-name">{{ finalExam?.title }}</h3>
          <p class="exam-description" *ngIf="finalExam?.description">
            {{ finalExam.description }}
          </p>
          <p class="exam-description" *ngIf="!finalExam?.description">
            This comprehensive exam will test your understanding of all course material.
          </p>

          <div class="exam-requirements">
            <div class="requirement-item">
              <i class="fas fa-check-circle"></i>
              <span>All modules completed</span>
            </div>
            <div class="requirement-item" *ngIf="finalExam?.pass_mark_percentage">
              <i class="fas fa-target"></i>
              <span>Pass mark: {{ finalExam.pass_mark_percentage }}%</span>
            </div>
            <div class="requirement-item" *ngIf="finalExam?.time_limit_minutes">
              <i class="fas fa-clock"></i>
              <span>Time limit: {{ finalExam.time_limit_minutes }} minutes</span>
            </div>
            <div class="requirement-item" *ngIf="finalExam?.question_count">
              <i class="fas fa-question-circle"></i>
              <span>{{ finalExam.question_count }} questions</span>
            </div>
            <div class="requirement-item" *ngIf="finalExam?.max_attempts">
              <i class="fas fa-redo"></i>
              <span>Maximum {{ finalExam.max_attempts }} attempts</span>
            </div>
          </div>
        </div>

        <div class="exam-action">
          <button
            class="btn-final-exam"
            (click)="attemptFinalExam()"
            [disabled]="!canTakeFinalExam">
            <i class="fas fa-graduation-cap"></i>
            <span>Attempt Final Exam</span>
          </button>
          <p class="exam-action-note">
            Make sure you're ready before starting. Good luck!
          </p>
        </div>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <button
        class="btn-nav"
        [disabled]="!canGoPrevious"
        (click)="goToPreviousContent()">
        <i class="fas fa-arrow-left"></i>
        <span>Previous Content</span>
      </button>
      <button
        class="btn-nav primary"
        [disabled]="(!canGoNext && !shouldShowStartQuiz) || (shouldShowStartQuiz && !canTakeQuiz)"
        (click)="goToNextContent()">
        <span>{{ nextButtonText }}</span>
        <i class="fas" [class.fa-arrow-right]="!shouldShowStartQuiz" [class.fa-play]="shouldShowStartQuiz"></i>
      </button>
    </div>

    <!-- Back to Course Button -->
    <div class="back-to-course">
      <button class="btn-back" (click)="backToCourse()">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Course</span>
      </button>
    </div>

  </div>
  <!-- âœ… CLOSED content-main div -->

</div>
<!-- âœ… CLOSED module-layout div -->

<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
  </div>
  <p class="loading-text">Loading module content...</p>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="error && !isLoading">
  <div class="error-icon">
    <i class="fas fa-exclamation-triangle"></i>
  </div>
  <h2 class="error-title">Failed to Load Module</h2>
  <p class="error-message">{{ error }}</p>
  <button class="btn-retry" (click)="loadModuleContent()">
    <i class="fas fa-redo"></i>
    <span>Retry</span>
  </button>
</div>
